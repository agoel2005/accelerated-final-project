=================================================
CUDA Attention Kernel Test Suite
=================================================

--- BASIC CORRECTNESS TESTS ---

========================================
Testing attention kernel:
  Batch size: 1
  Num heads: 1
  Sequence length: 4
  Head dimension: 8
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.008 ms
Optimized kernel time: 0.008 ms
Speedup: 0.93x

Checking baseline results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

Checking optimized results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

✓ TEST PASSED

========================================
Testing attention kernel:
  Batch size: 1
  Num heads: 2
  Sequence length: 8
  Head dimension: 16
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.008 ms
Optimized kernel time: 0.008 ms
Speedup: 0.95x

Checking baseline results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

Checking optimized results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

✓ TEST PASSED

========================================
Testing attention kernel:
  Batch size: 2
  Num heads: 4
  Sequence length: 32
  Head dimension: 32
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.010 ms
Optimized kernel time: 0.011 ms
Speedup: 0.95x

Checking baseline results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

Checking optimized results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

✓ TEST PASSED

========================================
Testing attention kernel:
  Batch size: 2
  Num heads: 8
  Sequence length: 64
  Head dimension: 64
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.033 ms
Optimized kernel time: 0.034 ms
Speedup: 0.98x

Checking baseline results vs CPU...
  Mismatch at index 0: GPU=0.162690, CPU=0.111791, diff=0.050900
  Mismatch at index 1: GPU=-0.001508, CPU=-0.074351, diff=0.072843
  Mismatch at index 2: GPU=0.021800, CPU=-0.038415, diff=0.060215
  Mismatch at index 3: GPU=0.020229, CPU=0.027999, diff=0.007770
  Mismatch at index 4: GPU=0.086365, CPU=0.039372, diff=0.046993
  Mismatch at index 5: GPU=-0.017477, CPU=0.009826, diff=0.027303
  Mismatch at index 6: GPU=0.086531, CPU=0.004528, diff=0.082003
  Mismatch at index 7: GPU=-0.091554, CPU=-0.072876, diff=0.018678
  Mismatch at index 8: GPU=-0.035934, CPU=-0.038945, diff=0.003011
  Mismatch at index 9: GPU=0.041913, CPU=0.081501, diff=0.039587
  Total mismatches: 64532 / 65536
  Max difference: 0.216638

Checking optimized results vs CPU...
  Mismatch at index 0: GPU=0.162690, CPU=0.111791, diff=0.050900
  Mismatch at index 1: GPU=-0.001508, CPU=-0.074351, diff=0.072843
  Mismatch at index 2: GPU=0.021800, CPU=-0.038415, diff=0.060215
  Mismatch at index 3: GPU=0.020229, CPU=0.027999, diff=0.007770
  Mismatch at index 4: GPU=0.086365, CPU=0.039372, diff=0.046993
  Mismatch at index 5: GPU=-0.017477, CPU=0.009826, diff=0.027303
  Mismatch at index 6: GPU=0.086531, CPU=0.004528, diff=0.082003
  Mismatch at index 7: GPU=-0.091554, CPU=-0.072876, diff=0.018678
  Mismatch at index 8: GPU=-0.035934, CPU=-0.038945, diff=0.003011
  Mismatch at index 9: GPU=0.041913, CPU=0.081501, diff=0.039587
  Total mismatches: 64532 / 65536
  Max difference: 0.216638

✗ TEST FAILED

========================================
Testing cross-attention kernel:
  Batch size: 1
  Num heads: 2
  Query sequence length: 16
  Key/Value sequence length: 32
  Head dimension: 32
========================================

Running GPU kernel...
Running CPU reference...

Checking results...
  Max difference: 0.000000 (within tolerance 0.001000)

✓ TEST PASSED

--- SMALL HEAD DIMENSION TESTS ---

========================================
Testing attention kernel:
  Batch size: 1
  Num heads: 4
  Sequence length: 16
  Head dimension: 64
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.010 ms
Optimized kernel time: 0.010 ms
Speedup: 0.96x

Checking baseline results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

Checking optimized results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

✓ TEST PASSED

========================================
Testing attention kernel:
  Batch size: 2
  Num heads: 8
  Sequence length: 64
  Head dimension: 128
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.047 ms
Optimized kernel time: 0.048 ms
Speedup: 0.99x

Checking baseline results vs CPU...
  Mismatch at index 0: GPU=0.074055, CPU=0.060175, diff=0.013880
  Mismatch at index 1: GPU=-0.149599, CPU=-0.072014, diff=0.077585
  Mismatch at index 2: GPU=0.083007, CPU=0.061960, diff=0.021047
  Mismatch at index 3: GPU=0.140218, CPU=0.104273, diff=0.035945
  Mismatch at index 4: GPU=0.014645, CPU=0.013199, diff=0.001447
  Mismatch at index 5: GPU=0.020843, CPU=0.029771, diff=0.008928
  Mismatch at index 6: GPU=-0.037601, CPU=-0.017299, diff=0.020301
  Mismatch at index 7: GPU=-0.179075, CPU=-0.103695, diff=0.075380
  Mismatch at index 8: GPU=-0.091784, CPU=-0.025312, diff=0.066472
  Mismatch at index 9: GPU=-0.022592, CPU=0.064133, diff=0.086724
  Total mismatches: 129208 / 131072
  Max difference: 0.221111

Checking optimized results vs CPU...
  Mismatch at index 0: GPU=0.074055, CPU=0.060175, diff=0.013880
  Mismatch at index 1: GPU=-0.149599, CPU=-0.072014, diff=0.077585
  Mismatch at index 2: GPU=0.083007, CPU=0.061960, diff=0.021047
  Mismatch at index 3: GPU=0.140218, CPU=0.104273, diff=0.035945
  Mismatch at index 4: GPU=0.014645, CPU=0.013199, diff=0.001447
  Mismatch at index 5: GPU=0.020843, CPU=0.029771, diff=0.008928
  Mismatch at index 6: GPU=-0.037601, CPU=-0.017299, diff=0.020301
  Mismatch at index 7: GPU=-0.179075, CPU=-0.103695, diff=0.075380
  Mismatch at index 8: GPU=-0.091784, CPU=-0.025312, diff=0.066472
  Mismatch at index 9: GPU=-0.022592, CPU=0.064133, diff=0.086724
  Total mismatches: 129208 / 131072
  Max difference: 0.221111

✗ TEST FAILED

--- LARGE HEAD DIMENSION TESTS (TARGET) ---

*** Testing hdim=512 (warmup for large dims) ***

========================================
Testing attention kernel:
  Batch size: 1
  Num heads: 4
  Sequence length: 64
  Head dimension: 512
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.045 ms
Optimized kernel time: 0.061 ms
Speedup: 0.75x

Checking baseline results vs CPU...
  Mismatch at index 0: GPU=-0.177541, CPU=-0.097977, diff=0.079565
  Mismatch at index 1: GPU=0.051564, CPU=0.043473, diff=0.008090
  Mismatch at index 2: GPU=-0.068311, CPU=-0.000368, diff=0.067943
  Mismatch at index 3: GPU=-0.054229, CPU=-0.063667, diff=0.009438
  Mismatch at index 4: GPU=-0.135329, CPU=-0.049289, diff=0.086040
  Mismatch at index 5: GPU=-0.062276, CPU=-0.065253, diff=0.002977
  Mismatch at index 6: GPU=-0.070161, CPU=-0.031272, diff=0.038889
  Mismatch at index 7: GPU=0.097233, CPU=0.072207, diff=0.025026
  Mismatch at index 8: GPU=-0.110987, CPU=-0.062363, diff=0.048624
  Mismatch at index 9: GPU=-0.046093, CPU=-0.040315, diff=0.005778
  Total mismatches: 129154 / 131072
  Max difference: 0.211836

Checking optimized results vs CPU...
  Mismatch at index 32: GPU=-0.251380, CPU=-0.124284, diff=0.127096
  Mismatch at index 33: GPU=-0.012045, CPU=-0.005955, diff=0.006090
  Mismatch at index 34: GPU=0.087458, CPU=0.043240, diff=0.044218
  Mismatch at index 35: GPU=-0.142494, CPU=-0.070450, diff=0.072044
  Mismatch at index 36: GPU=0.326850, CPU=0.161597, diff=0.165253
  Mismatch at index 37: GPU=0.006090, CPU=0.003011, diff=0.003079
  Mismatch at index 38: GPU=-0.005021, CPU=-0.002483, diff=0.002539
  Mismatch at index 39: GPU=-0.125951, CPU=-0.062271, diff=0.063680
  Mismatch at index 40: GPU=0.113492, CPU=0.056111, diff=0.057381
  Mismatch at index 41: GPU=0.098980, CPU=0.048937, diff=0.050044
  Total mismatches: 22640 / 131072
  Max difference: 0.291695

✗ TEST FAILED

*** Testing hdim=2048 ***

========================================
Testing attention kernel:
  Batch size: 1
  Num heads: 4
  Sequence length: 64
  Head dimension: 2048
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.156 ms
Optimized kernel time: 0.230 ms
Speedup: 0.68x

Checking baseline results vs CPU...
  Mismatch at index 0: GPU=-0.103497, CPU=-0.085658, diff=0.017840
  Mismatch at index 1: GPU=0.151049, CPU=0.095328, diff=0.055721
  Mismatch at index 2: GPU=-0.004295, CPU=-0.019772, diff=0.015476
  Mismatch at index 3: GPU=-0.100476, CPU=-0.035277, diff=0.065198
  Mismatch at index 4: GPU=0.106226, CPU=0.077481, diff=0.028745
  Mismatch at index 5: GPU=0.238241, CPU=0.101982, diff=0.136259
  Mismatch at index 6: GPU=0.136199, CPU=0.095320, diff=0.040879
  Mismatch at index 7: GPU=0.012726, CPU=0.045925, diff=0.033199
  Mismatch at index 8: GPU=0.054734, CPU=0.021887, diff=0.032847
  Mismatch at index 9: GPU=-0.054094, CPU=-0.048209, diff=0.005884
  Total mismatches: 516571 / 524288
  Max difference: 0.256271

Checking optimized results vs CPU...
  Mismatch at index 32: GPU=-0.088609, CPU=-0.045876, diff=0.042732
  Mismatch at index 33: GPU=-0.078110, CPU=-0.040441, diff=0.037669
  Mismatch at index 34: GPU=0.117852, CPU=0.061017, diff=0.056835
  Mismatch at index 35: GPU=0.140527, CPU=0.072757, diff=0.067770
  Mismatch at index 36: GPU=0.203104, CPU=0.105156, diff=0.097949
  Mismatch at index 37: GPU=0.305085, CPU=0.157956, diff=0.147130
  Mismatch at index 38: GPU=-0.069836, CPU=-0.036157, diff=0.033679
  Mismatch at index 40: GPU=-0.062805, CPU=-0.032517, diff=0.030288
  Mismatch at index 41: GPU=0.062104, CPU=0.032154, diff=0.029950
  Mismatch at index 42: GPU=-0.130419, CPU=-0.067523, diff=0.062896
  Total mismatches: 93483 / 524288
  Max difference: 0.287052

✗ TEST FAILED

*** Testing hdim=4096 ***

========================================
Testing attention kernel:
  Batch size: 1
  Num heads: 2
  Sequence length: 32
  Head dimension: 4096
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.167 ms
Optimized kernel time: 0.125 ms
Speedup: 1.33x

Checking baseline results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

Checking optimized results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

✓ TEST PASSED

*** Testing hdim=8192 ***

========================================
Testing attention kernel:
  Batch size: 1
  Num heads: 1
  Sequence length: 16
  Head dimension: 8192
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 0.266 ms
Optimized kernel time: 0.192 ms
Speedup: 1.39x

Checking baseline results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

Checking optimized results vs CPU...
  Max difference: 0.000000 (within tolerance 0.001000)

✓ TEST PASSED

--- REALISTIC WORKLOAD BENCHMARKS ---

*** LLaMA-style config: bs=4, nh=32, seq=512, hdim=128 ***

========================================
Testing attention kernel:
  Batch size: 4
  Num heads: 32
  Sequence length: 512
  Head dimension: 128
========================================

Running baseline GPU kernel...
Running OPTIMIZED GPU kernel...
Running CPU reference...

--- Performance Results ---
Baseline kernel time: 30.447 ms
Optimized kernel time: 30.296 ms
Speedup: 1.00x

Checking baseline results vs CPU...
  Mismatch at index 0: GPU=-0.484210, CPU=-0.062048, diff=0.422162
  Mismatch at index 1: GPU=-0.057830, CPU=-0.009794, diff=0.048036
  Mismatch at index 2: GPU=0.012308, CPU=-0.002030, diff=0.014338
  Mismatch at index 3: GPU=-0.126987, CPU=-0.020641, diff=0.106345
  Mismatch at index 4: GPU=0.265541, CPU=0.020707, diff=0.244833
  Mismatch at index 5: GPU=0.393892, CPU=0.036321, diff=0.357571
  Mismatch at index 6: GPU=0.001145, CPU=-0.000568, diff=0.001713
  Mismatch at index 7: GPU=0.297855, CPU=0.037885, diff=0.259971
  Mismatch at index 8: GPU=-0.131802, CPU=-0.003490, diff=0.128312
  Mismatch at index 9: GPU=0.238114, CPU=0.033795, diff=0.204319
  Total mismatches: 8350040 / 8388608
  Max difference: 0.819390

Checking optimized results vs CPU...
  Mismatch at index 0: GPU=-0.484210, CPU=-0.062048, diff=0.422162
  Mismatch at index 1: GPU=-0.057830, CPU=-0.009794, diff=0.048036
  Mismatch at index 2: GPU=0.012308, CPU=-0.002030, diff=0.014338
  Mismatch at index 3: GPU=-0.126987, CPU=-0.020641, diff=0.106345
  Mismatch at index 4: GPU=0.265541, CPU=0.020707, diff=0.244833
  Mismatch at index 5: GPU=0.393892, CPU=0.036321, diff=0.357571
  Mismatch at index 6: GPU=0.001145, CPU=-0.000568, diff=0.001713
  Mismatch at index 7: GPU=0.297855, CPU=0.037885, diff=0.259971
  Mismatch at index 8: GPU=-0.131802, CPU=-0.003490, diff=0.128312
  Mismatch at index 9: GPU=0.238114, CPU=0.033795, diff=0.204319
  Total mismatches: 8350040 / 8388608
  Max difference: 0.819390

✗ TEST FAILED

=================================================
All tests completed!
=================================================
